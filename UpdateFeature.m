function [nonZeroIndex_row, feature_row, residuals] = UpdateFeature(Wd, sample_row, residuals, feature_row, nonZeroIndex_row, lambda, layers, featureDim, sampleDim)
    residuals = -sample_row;
    residuals = residuals + sum(Wd(:,nonZeroIndex_row).* feature_row(nonZeroIndex_row),2);
    %randomIndex = [496,800,42,591,38,863,360,105,147,613,422,290,853,82,810,4,966,506,996,291,467,69,945,148,29,246,76,91,711,183,505,595,230,872,247,742,228,364,200,407,348,906,78,630,524,749,560,157,393,312,884,309,192,100,961,687,726,707,680,49,179,57,530,949,400,276,93,924,509,690,267,850,650,254,952,900,61,439,776,578,30,349,433,854,827,950,494,160,865,797,408,329,698,626,66,376,969,304,715,497,322,757,73,765,405,920,396,553,688,721,862,265,146,700,37,325,666,382,119,156,732,517,631,942,972,80,951,696,272,388,447,925,572,195,256,803,219,838,10,529,824,124,323,205,587,434,391,814,86,927,121,416,820,704,11,139,801,897,794,694,767,522,725,372,19,294,709,708,347,489,735,379,287,846,215,598,327,8,959,526,960,111,335,65,868,989,785,164,425,351,601,998,837,832,677,3,582,532,596,475,437,829,736,839,988,802,415,261,957,466,7,159,167,648,934,23,479,798,580,106,24,758,20,813,964,716,643,799,822,977,321,243,893,953,771,206,898,470,234,338,809,983,134,353,172,558,896,874,358,130,117,555,46,750,508,612,373,718,26,947,443,552,627,712,455,498,543,12,141,816,531,974,484,774,930,939,763,618,584,440,390,574,539,98,161,165,245,212,231,657,240,185,541,120,451,549,404,910,905,729,647,629,815,544,378,562,275,465,761,292,395,851,904,123,937,285,339,573,18,507,343,255,621,241,994,201,913,510,473,270,599,788,171,326,804,328,45,534,60,963,6,583,432,755,586,646,386,978,993,836,984,319,448,15,787,189,174,436,286,70,556,817,401,722,9,41,178,895,808,914,412,782,885,538,593,777,208,908,458,158,823,933,864,463,381,264,101,754,880,13,252,857,600,923,501,142,512,365,342,449,683,368,831,486,125,277,282,336,340,786,888,260,235,1,355,25,128,362,72,269,87,693,33,341,227,62,152,63,166,430,306,39,135,739,453,96,92,242,999,225,550,869,632,891,545,975,811,204,764,597,747,288,84,224,882,472,403,223,79,14,557,420,155,652,585,380,345,383,103,678,184,606,5,313,670,917,806,218,28,705,581,137,733,958,75,222,471,177,271,43,848,502,759,992,769,51,90,274,229,588,728,429,672,682,44,818,452,490,990,413,423,819,334,911,107,710,397,883,332,536,191,768,520,847,576,948,421,445,266,153,419,173,941,669,559,64,932,713,406,150,402,548,187,943,180,71,956,830,965,442,625,88,352,314,686,833,570,138,753,554,35,68,991,95,67,533,792,350,344,699,81,561,968,936,756,527,946,237,251,915,535,962,209,720,48,658,375,143,662,845,456,305,27,727,226,273,278,262,681,684,499,840,655,519,894,844,77,886,889,154,568,921,635,551,492,997,366,875,916,293,333,59,892,970,417,162,207,411,685,566,446,300,692,301,133,89,772,311,36,511,493,280,876,302,901,31,424,852,899,203,34,881,289,638,826,315,284,770,751,873,540,656,476,701,259,371,194,780,867,131,110,197,878,737,318,890,611,590,639,661,257,575,491,609,636,637,746,642,607,589,515,428,316,97,623,821,359,624,912,697,976,220,743,944,789,617,356,805,676,752,441,986,702,211,856,503,244,807,239,477,644,114,620,564,719,717,444,855,94,250,102,330,236,640,667,387,182,188,409,298,16,40,903,168,935,775,53,297,610,674,714,619,985,175,723,122,841,835,849,773,151,734,731,926,504,825,675,877,730,879,487,331,109,571,542,55,518,324,615,909,577,116,660,136,370,760,299,17,971,427,938,170,887,346,634,614,99,781,514,546,483,603,394,317,410,361,664,979,248,127,744,52,605,919,649,169,982,843,740,426,778,450,438,310,481,973,703,217,673,480,85,980,22,565,279,337,163,616,645,537,547,922,745,795,54,592,604,622,454,860,940,213,793,525,296,457,307,108,931,74,214,594,414,363,812,929,0,118,32,741,2,858,513,790,500,579,198,706,112,791,633,691,126,461,233,357,140,210,478,967,981,679,462,303,796,104,190,569,460,21,602,253,859,181,918,308,374,263,431,221,392,144,523,202,516,987,283,651,384,474,955,132,834,47,129,671,115,779,268,738,367,842,665,216,695,495,902,232,58,866,249,295,485,435,488,50,659,724,377,653,528,567,459,196,238,608,320,369,563,762,641,663,861,258,668,281,928,199,521,389,186,766,385,399,870,418,689,871,784,907,145,628,468,354,464,83,193,482,56,113,176,654,398,954,748,995,149,828,469,783];
    %randomIndex = randomIndex + 1;
    randomIndex = randperm(featureDim);
    
    for i = 1:featureDim
        derivative = 0;
        derivative = derivative + sum(residuals .* Wd(:,randomIndex(i)));
        optimalT = ShrinkageFunction(feature_row(randomIndex(i)) - derivative, lambda) - feature_row(randomIndex(i));
        feature_row(randomIndex(i)) = feature_row(randomIndex(i)) + optimalT;
        if optimalT ~=0
            residuals = residuals + optimalT * Wd(:,randomIndex(i));
        end
    end
    nonZeroIndex_row = logical(feature_row);
    
    for l = 1:layers
        for i = 1:featureDim
            if nonZeroIndex_row(i) == 1
                derivative = 0;
                derivative = derivative + sum(residuals .* Wd(:,i));
                optimalT = ShrinkageFunction(feature_row(i) - derivative, lambda) - feature_row(i);
                feature_row(i) = feature_row(i) + optimalT;
                if optimalT ~=0
                    residuals = residuals + optimalT * Wd(:,i);
                end
            end
        end
    end
    nonZeroIndex_row = logical(feature_row);
end 